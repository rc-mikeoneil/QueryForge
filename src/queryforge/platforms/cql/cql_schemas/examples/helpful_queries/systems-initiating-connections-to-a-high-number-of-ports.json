{
  "id": "systems-initiating-connections-to-a-high-number-of-ports",
  "title": "Systems Initiating Connections to a High Number of Ports",
  "source_file": "Queries-Only/Helpful-CQL-Queries/Systems Initiating Connections to a High Number of Ports.md",
  "category": "helpful_query",
  "subcategory": "process",
  "description": "Could be indicative of a system with Falcon installed on it conducting network scanning.",
  "mitre_attack": null,
  "event_types": [
    "NetworkConnectIP4",
    "ProcessRollup2"
  ],
  "functions_used": [
    "count",
    "groupBy",
    "selfJoinFilter",
    "test"
  ],
  "operators_used": [
    "=",
    ">",
    "|"
  ],
  "fields_referenced": [
    "FileName",
    "RemotePort",
    "as",
    "distinct",
    "field",
    "function",
    "limit",
    "separator",
    "where"
  ],
  "correlation_patterns": [
    "selfJoinFilter"
  ],
  "difficulty": "expert",
  "query_type": "analysis",
  "platforms": [
    "Lin"
  ],
  "use_case": "Could be indicative of a system with Falcon installed on it conducting network scanning.",
  "query": "#event_simpleName=/^(NetworkConnectIP4|ProcessRollup2)$/ \n| falconPID:=TargetProcessId | falconPID:=ContextProcessId\n| UserID:=UserSid | UserID:=UID\n| selfJoinFilter(field=[aid, falconPID], where=[{#event_simpleName=NetworkConnectIP4}, {#event_simpleName=ProcessRollup2}])\n| groupBy([aid, ComputerName, falconPID], function=([\n\tcollect([FileName, CommandLine, UserName, UserID]), \n\tcount(RemotePort, as=uniquePortCount), \n\tcollect([RemotePort], separator=\", \", limit=25), \n\tcount(RemoteAddressIP4, distinct=true, as=remoteIPcount)\n\t]), limit=max)\n| FileName=* RemotePort=*\n| test(uniquePortCount>25)",
  "key_features": [
    "Uses selfJoinFilter for correlation",
    "Advanced correlation techniques"
  ],
  "related_examples": [],
  "tags": [
    "lin",
    "networkconnectip4",
    "processrollup2"
  ]
}