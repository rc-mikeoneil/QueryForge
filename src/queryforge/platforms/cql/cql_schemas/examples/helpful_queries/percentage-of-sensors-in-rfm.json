{
  "id": "percentage-of-sensors-in-rfm",
  "title": "Percentage of Sensors in RFM",
  "source_file": "Queries-Only/Helpful-CQL-Queries/Percentage of Sensors in RFM.md",
  "category": "helpful_query",
  "subcategory": null,
  "description": "",
  "mitre_attack": null,
  "event_types": [
    "SensorHeartbeat"
  ],
  "functions_used": [
    "count",
    "format",
    "groupBy",
    "selectFromMax",
    "table"
  ],
  "operators_used": [
    "=",
    ">",
    "and",
    "in",
    "|"
  ],
  "fields_referenced": [
    "SensorStateBitMap",
    "as",
    "field",
    "format",
    "function",
    "include"
  ],
  "correlation_patterns": [],
  "difficulty": "intermediate",
  "query_type": "analysis",
  "platforms": [
    "Lin",
    "Mac",
    "Win"
  ],
  "use_case": "Analysis query for Percentage of Sensors in RFM",
  "query": "// Get SensorHeartbeat events for Windows, macOS, and Linux\n#event_simpleName=SensorHeartbeat event_platform=/(^(Win|Mac|Lin)$)/\n// Get most recent event for each aid value and include event_platform\n| groupBy([event_platform, aid], function=([selectFromMax(field=\"@timestamp\", include=[SensorStateBitMap])]))\n// Aggregate by event_platform and count by SensorStateBitMap\n| groupBy(event_platform, function=([{SensorStateBitMap=2 | count(as=RFM) }, {SensorStateBitMap=0 | count(as=OK)}])) \n// Create total and percentage values\n| Total:= RFM + OK | PercentRFM := (RFM / Total) * 100 \n// Optional: set threshold for % of systems in RFM; uncomment if desired\n// | PercentRFM > 5\n// Format percentage value\n| PercentRFM:= format(format=\"%,.2f%%\", field=[PercentRFM])\n// Order fields with table\n| table([event_platform, Total, RFM, OK, PercentRFM])",
  "key_features": [],
  "related_examples": [],
  "tags": [
    "lin",
    "mac",
    "sensorheartbeat",
    "win"
  ]
}