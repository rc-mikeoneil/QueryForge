{
  "id": "rare-and-common-encrypted-command-lines",
  "title": "Rare and Common Encrypted Command Lines",
  "source_file": "Queries-Only/Helpful-CQL-Queries/Rare and Common Encrypted Command Lines.md",
  "category": "helpful_query",
  "subcategory": "process",
  "description": "",
  "mitre_attack": null,
  "event_types": [
    "ProcessRollup2"
  ],
  "functions_used": [
    "count",
    "length",
    "sort",
    "stats",
    "table"
  ],
  "operators_used": [
    "=",
    "|"
  ],
  "fields_referenced": [
    "CommandLine",
    "ImageFileName",
    "as",
    "cmdLength",
    "distinct",
    "function",
    "limit",
    "order"
  ],
  "correlation_patterns": [],
  "difficulty": "intermediate",
  "query_type": "analysis",
  "platforms": [
    "Lin",
    "Win"
  ],
  "use_case": "Analysis query for Rare and Common Encrypted Command Lines",
  "query": "#event_simpleName=ProcessRollup2 event_platform=Win ImageFileName=/.*\\\\powershell\\.exe/\n\n| CommandLine=/.*\\s+\\-(e|encoded|encodedcommand|enc)\\s+.*/\n| length(\"CommandLine\", as=\"cmdLength\")\n| groupby([CommandLine], function=stats([collect(cmdLength), count(aid, distinct=true, as=\"uniqueEndpointCount\"), count(aid, as=\"executionCount\")]), limit=max)\n| table([executionCount, uniqueEndpoitnCount, cmdLength, CommandLine])\n| sort(executionCount, order=desc)",
  "key_features": [],
  "related_examples": [],
  "tags": [
    "lin",
    "processrollup2",
    "win"
  ]
}