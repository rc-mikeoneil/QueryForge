{
  "id": "cve-2025-1146-system-scoping-osversioninfo-with-logon-data",
  "title": "CVE-2025-1146 System Scoping (OsVersionInfo with Logon Data)",
  "source_file": "Queries-Only/Helpful-CQL-Queries/CVE-2025-1146 System Scoping (OsVersionInfo with Logon Data).md",
  "category": "helpful_query",
  "subcategory": null,
  "description": "",
  "mitre_attack": null,
  "event_types": [
    "UserLogon",
    "OsVersionInfo"
  ],
  "functions_used": [
    "default",
    "drop",
    "groupBy",
    "in",
    "join",
    "match",
    "rename"
  ],
  "operators_used": [
    "<",
    "<=",
    "=",
    ">",
    "and",
    "in",
    "match",
    "or",
    "|"
  ],
  "fields_referenced": [
    "AgentVersion",
    "LogonType",
    "Pod",
    "ProductType",
    "aid",
    "as",
    "column",
    "field",
    "file",
    "format",
    "function",
    "include",
    "limit",
    "majorVersion",
    "minorVersion",
    "mode",
    "query",
    "replaceEmpty",
    "start",
    "strict"
  ],
  "correlation_patterns": [
    "join"
  ],
  "difficulty": "advanced",
  "query_type": "hunting",
  "platforms": [
    "Lin",
    "Mac"
  ],
  "use_case": "Hunting query for CVE-2025-1146 System Scoping (OsVersionInfo with Logon Data)",
  "query": "/* \n\nThe query below will look for Linux systems (Linux, K8, Containers) that need to be updated against CVE-2025-1146. \n\nThe query is based on the event OsVersionInfo which is generated every 24-hours, at sensor start, or at sensor update.   \n\nIt attempts to merge in LogonType 2 and 10 to determine the last logged on user.\n\n*/\n \n// Get OsVersionInfo events; sent by sensor every 24-hours or at sensor start or update\n#event_simpleName=OsVersionInfo\n \n// Narrow search to only include Linux, Container, and K8 systems\n| in(field=\"event_platform\", values=[Lin, K8S])\n\n// Enrich required fields from aid_master_main.csv\n| aid=~match(file=\"aid_master_main.csv\", column=[aid], include=[ProductType, Version, MAC, SystemManufacturer, SystemProductName, FirstSeen, Time], strict=false)\n \n// Parse AgentVersion into individual components for evaluation\n| AgentVersion=/^(?<majorVersion>\\d+)\\.(?<minorVersion>\\d+)\\.(?<buildNumber>\\d+)\\./\n \n// Evaluate Linux Container Sensors\n| case {\n    event_platform=Lin ProductType=Pod majorVersion=6                                 | Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion<=5                 | Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion=6  buildNumber<4705| Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion=10 buildNumber<4907| Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion=11 buildNumber<5003| Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion=12 buildNumber<5102| Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion=13 buildNumber<5202| Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion=14 buildNumber<5306| Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion=15 buildNumber<5403| Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion=16 buildNumber<5503| Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion=17 buildNumber<5603| Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion=18 buildNumber<5705| Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion=19 buildNumber<5807| Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod majorVersion=7 minorVersion=20 buildNumber<5908| Status:=\"NEEDS PATCH\" | event_platform:=\"Lin (Pod)\";\n    event_platform=Lin ProductType=Pod                                                | Status:=\"OK\"          | event_platform:=\"Lin (Pod)\";\n    *;\n}\n// Evaluate Linux Sensors\n| case {\n    event_platform=Lin majorVersion=6                                  | Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion<=5                  | Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion=6 buildNumber<16113 | Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion=7 buildNumber<16209 | Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion=10 buildNumber<16321| Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion=11 buildNumber<16410| Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion=13 buildNumber<16606| Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion=14 buildNumber<16705| Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion=15 buildNumber<16806| Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion=16 buildNumber<16909| Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion=17 buildNumber<17014| Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion=18 buildNumber<17131| Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion=19 buildNumber<17221| Status:=\"NEEDS PATCH\";\n    event_platform=Lin majorVersion=7 minorVersion=20 buildNumber<17308| Status:=\"NEEDS PATCH\";\n    event_platform=Lin                                                 | Status:=\"OK\";\n    *;\n}\n// Evaluate K8 Sensors\n| case {\n    event_platform=K8S majorVersion=6                                 | Status:=\"NEEDS PATCH\";\n    event_platform=K8S majorVersion=7 minorVersion<=5                 | Status:=\"NEEDS PATCH\";\n    event_platform=K8S majorVersion=7 minorVersion=6 buildNumber<603  | Status:=\"NEEDS PATCH\";\n    event_platform=K8S majorVersion=7 minorVersion=10 buildNumber<806 | Status:=\"NEEDS PATCH\";\n    event_platform=K8S majorVersion=7 minorVersion=11 buildNumber<904 | Status:=\"NEEDS PATCH\";\n    event_platform=K8S majorVersion=7 minorVersion=12 buildNumber<1002| Status:=\"NEEDS PATCH\";\n    event_platform=K8S majorVersion=7 minorVersion=13 buildNumber<1102| Status:=\"NEEDS PATCH\";\n    event_platform=K8S majorVersion=7 minorVersion=14 buildNumber<1203| Status:=\"NEEDS PATCH\";\n    event_platform=K8S majorVersion=7 minorVersion=16 buildNumber<1403| Status:=\"NEEDS PATCH\";\n    event_platform=K8S majorVersion=7 minorVersion=17 buildNumber<1503| Status:=\"NEEDS PATCH\";\n    event_platform=K8S majorVersion=7 minorVersion=18 buildNumber<1605| Status:=\"NEEDS PATCH\";\n    event_platform=K8S majorVersion=7 minorVersion=20 buildNumber<1808| Status:=\"NEEDS PATCH\";\n    event_platform=K8S                                                | Status:=\"OK\";\n    *;\n}\n \n// Aggregate results into tabular format\n| groupBy([cid, aid], function=([selectLast([cid, cid, ComputerName, event_platform, Version, AgentVersion, Status, aip, LocalAddressIP4, MAC, SystemManufacturer, SystemProductName, FirstSeen, Time])]), limit=max)\n\n// Add user logon data if available\n| join(query={#event_simpleName=UserLogon LogonType=/^(2|10)$/ event_platform=Lin | groupBy([aid], function=[(selectLast([UserName, UID, LogonType]))])}, field=[aid], include=[UserName, UID, LogonType], start=7d, mode=left)\n \n// Modify field names for easier reading\n| rename([[cid, \"Customer ID\"],[aid, \"Agent ID\"], [event_platform, Platform], [aip, \"External IP\"]])\n\n// Aggregate results into tabular format with cleaner ordering\n| groupBy([\"Customer ID\", \"Agent ID\", ComputerName, UserName, UID, LogonType, Platform, Version, AgentVersion, Status, \"External IP\", LocalAddressIP4, MAC, SystemManufacturer, SystemProductName, FirstSeen, Time], function=[], limit=max)\n \n// Set default values for easier reading\n| default(value=\"-\", field=[ComputerName, Version, AgentVersion, Status, LocalAddressIP4, MAC, SystemManufacturer, SystemProductName, FirstSeen, Time, UID, UserName, LogonType], replaceEmpty=true)\n\n// Move LogonType to human readable\n| case {\n    LogonType=2 | LogonType:=\"Interactive\";\n    LogonType=10| LogonType:=\"SSH\";\n    *;\n}\n \n// Move timestamps from epoch to human readable\n| formatTime(format=\"%F %T\", as=\"FirstSeen\", field=FirstSeen)\n| formatTime(format=\"%F %T\", as=\"LastSeen\", field=Time) \n\n// Remove unnecessary field\n| drop([Time])",
  "key_features": [
    "Uses join for correlation"
  ],
  "related_examples": [],
  "tags": [
    "join",
    "lin",
    "mac",
    "osversioninfo",
    "userlogon"
  ]
}